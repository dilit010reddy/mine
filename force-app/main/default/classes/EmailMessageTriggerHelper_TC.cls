@isTest
public with sharing class EmailMessageTriggerHelper_TC {
    static testMethod void testmeth() {
        List<Case> cseList = new List<Case>();
        Case cse = new Case(Subject='Test Case 1');
        cseList.add(cse);
        Case cse1 = new Case(Subject='Test Case 2');
        cseList.add(cse1);
        insert cseList;

        EmailMessage em = new EmailMessage();
        em.Headers = 'Return-Path: reynchr@gmail.com'+'\n'+'Authentication-Results: mx3-ia5-sp2.mta.salesforce.com x-tls.subject="/CN=smtp.gmail.com"; auth=pass (cipher=ECDHE-RSA-AES128-GCM-SHA256)'+'\n'+'Authentication-Results: apex.salesforce.com; dkim=fail (signature verification failed) header.d=gmail.com'+'\n'+'Received: from [209.85.166.180] ([209.85.166.180:37506] helo=mail-il1-f180.google.com)	by mx3-ia5-sp2.mta.salesforce.com (envelope-from <reynchr@gmail.com>)	(ecelerity 4.2.38.62368 r(Core:release/4.2.38.0)) with ESMTPS (cipher=ECDHE-RSA-AES128-GCM-SHA256	subject="/CN=smtp.gmail.com") 	id 77/3E-06117-277E4B26; Thu, 23 Jun 2022 22:21:38 +0000'+'\n'+'Received: by mail-il1-f180.google.com with SMTP id w10so320163ilj.4        for <chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com>; Thu, 23 Jun 2022 15:21:38 -0700 (PDT)'+'\n'+'DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=gmail.com; s=20210112;        h=from:to:subject:thread-topic:thread-index:date:message-id         :references:in-reply-to:accept-language:content-language         :mime-version;        bh=NsJ6kI0zAD9bfK2vpG8nFNiSBr1TUz7/6rR999r0K0M=;        b=AwBhii40yl/7J/Ji60k7D6fFrMwxZHrXEPoU7fv5vdudhfwgdxlcHpD6bWjbdp4YWI         G9a5orvfqA2ON+GCXG3YFvQMqlnLguGciPt7EYxx0714hiKDq6OuLZLHvDybxgPucYHC         SLFwinbRDcP+pPvJ0uerPLy1hSOiVlCK52R2uhnPi9uKDxOcgZ6qD1o28ijSLeaV8c6Y         GEn482I+qbY4DbJYhiufvtAWuaxZFljMSXVvYBiRAG6E3eIOlobN2f/3HqeQuj74ztJs         5/ienTZuWkilUmz8QVsWAI2I8lhkOJp4TmA/aKePgB7Oy8SCYweocKYIyZ44Wl5uGd/h         f9CA=='+'\n'+'X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=1e100.net; s=20210112;        h=x-gm-message-state:from:to:subject:thread-topic:thread-index:date         :message-id:references:in-reply-to:accept-language:content-language         :mime-version;        bh=NsJ6kI0zAD9bfK2vpG8nFNiSBr1TUz7/6rR999r0K0M=;        b=45p4u61dyhBZVIES05xQllHB8VhCcoCUo2B/2SPgpIZSqRI7oWoj/A72wee5eyENUl         44ouGmGBadPj1RltyPBHA1+ABEhpEG9z3dNziN50jLJdtx4M1HGXSLmpLhSp8WeK9idE         bdXFYRGVqJn4wlGqbf+nTQsVes4NqIAcIPelFEolvS/8ZSVd5fj6w+xLbgWLeE13XVqY         cOCtHfYwDMF1ezupWTtcr5uVWkrRZbsQp3oWP4KtPd3mL3xKlgCPs4Dn32zzDtWO7Fpr         w1FO+V3X/zqERNHwgQBAD99PbrgUXozGzZis6Ee+TBu1U/m4p8ox3kt2VVrBd84TpUTw         ofUw=='+'\n'+'X-Gm-Message-State: AJIora/IlZAl5C9QVp78ng1OUk14+HiM+mqN7AMH9PJNVEo9W7Vju7S6	LXkfmLSXgWlGWXFndMHb142j1fOte8o='+'\n'+'X-Google-Smtp-Source: AGRyM1sc0X9n2HOxmlvJECNX2aKKuKXgySeoyw0FkVxnm26aKkSsMMopmrwFgpZHbcATW5EoxQ6DGw=='+'\n'+'X-Received: by 2002:a92:c909:0:b0:2d9:1e8f:276c with SMTP id t9-20020a92c909000000b002d91e8f276cmr6461149ilp.305.1656022897981;        Thu, 23 Jun 2022 15:21:37 -0700 (PDT)'+'\n'+'Received: from DM4PR10MB5941.namprd10.prod.outlook.com ([2603:1036:301:444b::5])        by smtp.gmail.com with ESMTPSA id t13-20020a92d14d000000b002d8e825e077sm338945ilg.75.2022.06.23.15.21.36        (version=TLS1_2 cipher=ECDHE-ECDSA-AES128-GCM-SHA256 bits=128/128);        Thu, 23 Jun 2022 15:21:36 -0700 (PDT)'+'\n'+'From: Chris Reynolds <reynchr@gmail.com>'+'\n'+'To: Chris Reynolds <chris.reynolds@quantumrhino.com>,	"chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com"	<chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com>'+'\n'+'Subject: Re: Problem with HOA'+'\n'+'Thread-Topic: Problem with HOA'+'\n'+'Thread-Index: AQHYh09aIa9AJVTGD0ub+KRzXJOzo61dkIr7'+'\n'+'X-MS-Exchange-MessageSentRepresentingType: 1'+'\n'+'Date: Thu, 23 Jun 2022 22:21:33 +0000'+'\n'+'Message-ID: <11110MB59411BE600570A7AFD6F3BD0ADB59@DM4PR10MB5941.namprd10.prod.outlook.com>'+'\n'+'In-Reply-To: <MW4PR16MB5007A206A3C25A4A90FCD344F9B59@MW4PR16MB5007.namprd16.prod.outlook.com>'+'\n'+'Accept-Language: en-US'+'\n'+'Content-Language: en-US'+'\n'+'X-MS-Has-Attach: '+'\n'+'X-MS-Exchange-Organization-SCL: -1'+'\n'+'X-MS-TNEF-Correlator: '+'\n'+'X-MS-Exchange-Organization-RecordReviewCfmType: 0'+'\n'+'Content-Type: multipart/alternative;	boundary="_000_DM4PR10MB59411BE600570A7AFD6F3BD0ADB59DM4PR10MB5941namp_"'+'\n'+'MIME-Version: 1.0'+'\n'+'X-SFDC-Interface: external'+'\n'+'X-SFDC-SPF: Pass'+'\n'+'X-SFDC-SENDERID: Pass'+'\n'+'X-SFDC-SENDERID-PRA: Pass'+'\n'+'X-SFDC-TLS-STATUS: true'+'\n'+'X-SFDC-TLS-CIPHER: ECDHE-RSA-AES128-GCM-SHA256'+'\n'+'X-SFDC-TLS-VERIFIED: yes'+'\n'+'X-SFDC-TLS-VERSION: TLSv1.2'+'\n'+'X-SFDC-DOMAINKEYS: None'+'\n'+'X-SFDC-Binding: coremailprocessor'+'\n'+'X-SFDC-Original-RCPT: chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com';
        em.Incoming = TRUE;
        em.MessageDate = System.now();
        em.MessageIdentifier = '<DM4PR10MB59411BE600570A7AFD6F3BD0ADB59@DM4PR10MB5941.namprd10.prod.outlook.com>';
        em.Message_ID__c = '';
        em.ParentId = cse.Id;
        em.RelatedToId = cse.Id;
        em.Status = '1';
        em.Subject = 'Test';
        em.TextBody = 'Test';
        em.ThreadIdentifier = '<MW4PR16MB5007A206A3C25A4A90FCD344F9B59@MW4PR16MB5007.namprd16.prod.outlook.com>';
        em.ToAddress = 'test@email.com';
        insert em;

        List<Case> caseSOQL = [SELECT Id FROM Case];
        System.AssertEquals(2,caseSOQL.size());
        List<EmailMessage> emSOQL = [SELECT Id FROM EmailMessage];
        System.AssertEquals(1,emSOQL.size());

        EmailMessage em1 = new EmailMessage();
        em1.Headers = 'Return-Path: reynchr@gmail.com'+'\n'+'Authentication-Results: mx3-ia5-sp2.mta.salesforce.com x-tls.subject="/CN=smtp.gmail.com"; auth=pass (cipher=ECDHE-RSA-AES128-GCM-SHA256)'+'\n'+'Authentication-Results: apex.salesforce.com; dkim=fail (signature verification failed) header.d=gmail.com'+'\n'+'Received: from [209.85.166.180] ([209.85.166.180:37506] helo=mail-il1-f180.google.com)	by mx3-ia5-sp2.mta.salesforce.com (envelope-from <reynchr@gmail.com>)	(ecelerity 4.2.38.62368 r(Core:release/4.2.38.0)) with ESMTPS (cipher=ECDHE-RSA-AES128-GCM-SHA256	subject="/CN=smtp.gmail.com") 	id 77/3E-06117-277E4B26; Thu, 23 Jun 2022 22:21:38 +0000'+'\n'+'Received: by mail-il1-f180.google.com with SMTP id w10so320163ilj.4        for <chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com>; Thu, 23 Jun 2022 15:21:38 -0700 (PDT)'+'\n'+'DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=gmail.com; s=20210112;        h=from:to:subject:thread-topic:thread-index:date:message-id         :references:in-reply-to:accept-language:content-language         :mime-version;        bh=NsJ6kI0zAD9bfK2vpG8nFNiSBr1TUz7/6rR999r0K0M=;        b=AwBhii40yl/7J/Ji60k7D6fFrMwxZHrXEPoU7fv5vdudhfwgdxlcHpD6bWjbdp4YWI         G9a5orvfqA2ON+GCXG3YFvQMqlnLguGciPt7EYxx0714hiKDq6OuLZLHvDybxgPucYHC         SLFwinbRDcP+pPvJ0uerPLy1hSOiVlCK52R2uhnPi9uKDxOcgZ6qD1o28ijSLeaV8c6Y         GEn482I+qbY4DbJYhiufvtAWuaxZFljMSXVvYBiRAG6E3eIOlobN2f/3HqeQuj74ztJs         5/ienTZuWkilUmz8QVsWAI2I8lhkOJp4TmA/aKePgB7Oy8SCYweocKYIyZ44Wl5uGd/h         f9CA=='+'\n'+'X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=1e100.net; s=20210112;        h=x-gm-message-state:from:to:subject:thread-topic:thread-index:date         :message-id:references:in-reply-to:accept-language:content-language         :mime-version;        bh=NsJ6kI0zAD9bfK2vpG8nFNiSBr1TUz7/6rR999r0K0M=;        b=45p4u61dyhBZVIES05xQllHB8VhCcoCUo2B/2SPgpIZSqRI7oWoj/A72wee5eyENUl         44ouGmGBadPj1RltyPBHA1+ABEhpEG9z3dNziN50jLJdtx4M1HGXSLmpLhSp8WeK9idE         bdXFYRGVqJn4wlGqbf+nTQsVes4NqIAcIPelFEolvS/8ZSVd5fj6w+xLbgWLeE13XVqY         cOCtHfYwDMF1ezupWTtcr5uVWkrRZbsQp3oWP4KtPd3mL3xKlgCPs4Dn32zzDtWO7Fpr         w1FO+V3X/zqERNHwgQBAD99PbrgUXozGzZis6Ee+TBu1U/m4p8ox3kt2VVrBd84TpUTw         ofUw=='+'\n'+'X-Gm-Message-State: AJIora/IlZAl5C9QVp78ng1OUk14+HiM+mqN7AMH9PJNVEo9W7Vju7S6	LXkfmLSXgWlGWXFndMHb142j1fOte8o='+'\n'+'X-Google-Smtp-Source: AGRyM1sc0X9n2HOxmlvJECNX2aKKuKXgySeoyw0FkVxnm26aKkSsMMopmrwFgpZHbcATW5EoxQ6DGw=='+'\n'+'X-Received: by 2002:a92:c909:0:b0:2d9:1e8f:276c with SMTP id t9-20020a92c909000000b002d91e8f276cmr6461149ilp.305.1656022897981;        Thu, 23 Jun 2022 15:21:37 -0700 (PDT)'+'\n'+'Received: from DM4PR10MB5941.namprd10.prod.outlook.com ([2603:1036:301:444b::5])        by smtp.gmail.com with ESMTPSA id t13-20020a92d14d000000b002d8e825e077sm338945ilg.75.2022.06.23.15.21.36        (version=TLS1_2 cipher=ECDHE-ECDSA-AES128-GCM-SHA256 bits=128/128);        Thu, 23 Jun 2022 15:21:36 -0700 (PDT)'+'\n'+'From: Chris Reynolds <reynchr@gmail.com>'+'\n'+'To: Chris Reynolds <chris.reynolds@quantumrhino.com>,	"chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com"	<chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com>'+'\n'+'Subject: Re: Problem with HOA'+'\n'+'Thread-Topic: Problem with HOA'+'\n'+'Thread-Index: AQHYh09aIa9AJVTGD0ub+KRzXJOzo61dkIr7'+'\n'+'X-MS-Exchange-MessageSentRepresentingType: 1'+'\n'+'Date: Thu, 23 Jun 2022 22:21:33 +0000'+'\n'+'Message-ID: <11116MB5007A206A3C25A4A90FCD344F9B59@MW4PR16MB5007.namprd16.prod.outlook.com>'+'\n'+'References: <11110MB59411BE600570A7AFD6F3BD0ADB59@DM4PR10MB5941.namprd10.prod.outlook.com>'+'\n'+'In-Reply-To: <MW4PR16MB5007A206A3C25A4A90FCD344F9B59@MW4PR16MB5007.namprd16.prod.outlook.com>'+'\n'+'Accept-Language: en-US'+'\n'+'Content-Language: en-US'+'\n'+'X-MS-Has-Attach: '+'\n'+'X-MS-Exchange-Organization-SCL: -1'+'\n'+'X-MS-TNEF-Correlator: '+'\n'+'X-MS-Exchange-Organization-RecordReviewCfmType: 0'+'\n'+'Content-Type: multipart/alternative;	boundary="_000_DM4PR10MB59411BE600570A7AFD6F3BD0ADB59DM4PR10MB5941namp_"'+'\n'+'MIME-Version: 1.0'+'\n'+'X-SFDC-Interface: external'+'\n'+'X-SFDC-SPF: Pass'+'\n'+'X-SFDC-SENDERID: Pass'+'\n'+'X-SFDC-SENDERID-PRA: Pass'+'\n'+'X-SFDC-TLS-STATUS: true'+'\n'+'X-SFDC-TLS-CIPHER: ECDHE-RSA-AES128-GCM-SHA256'+'\n'+'X-SFDC-TLS-VERIFIED: yes'+'\n'+'X-SFDC-TLS-VERSION: TLSv1.2'+'\n'+'X-SFDC-DOMAINKEYS: None'+'\n'+'X-SFDC-Binding: coremailprocessor'+'\n'+'X-SFDC-Original-RCPT: chris.reynolds@i-ssn8pc63eego3rodbye1i9qy21ht5i2rqja77dea0099n6867.6s-4eayeaa.cs165.case.sandbox.salesforce.com';
        em1.Incoming = TRUE;
        em1.MessageDate = System.now();
        em1.MessageIdentifier = '<DM4PR10MB59411BE600570A7AFD6F3BD0ADB59@DM4PR10MB5941.namprd10.prod.outlook.com>';
        em1.Message_ID__c = '';
        em1.ParentId = cse1.Id;
        em1.RelatedToId = cse1.Id;
        em1.Status = '1';
        em1.Subject = 'Test';
        em1.TextBody = 'Test';
        em1.ThreadIdentifier = '<MW4PR16MB5007A206A3C25A4A90FCD344F9B59@MW4PR16MB5007.namprd16.prod.outlook.com>';
        em1.ToAddress = 'test@email.com';
        insert em1;

        List<Case> caseSOQL2 = [SELECT Id FROM Case];
        System.AssertEquals(1,caseSOQL2.size());
        List<EmailMessage> emCseSOQL = [SELECT Id FROM EmailMessage WHERE ParentId = :cse.Id];
        System.AssertEquals(2,emCseSOQL.size());
    }
}